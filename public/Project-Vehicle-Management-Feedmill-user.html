<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vehicle and Maintenance Tables</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="custom_styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
    /* Professional Design System */
    :root {
        --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        --secondary-gradient: linear-gradient(135deg, #8e44ad 0%, #3498db 100%);
        --success-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        --warning-gradient: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        --dark-bg: #2c3e50;
        --card-bg: rgba(255, 255, 255, 0.98);
        --text-dark: #2c3e50;
        --text-light: #ffffff;
        --border-glow: 0 0 20px rgba(52, 152, 219, 0.2);
        --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.12);
        --shadow-hard: 0 6px 25px rgba(0, 0, 0, 0.18);
        --border-radius: 12px;
        --spacing-xs: 0.5rem;
        --spacing-sm: 1rem;
        --spacing-md: 1.5rem;
        --spacing-lg: 2rem;
        --spacing-xl: 3rem;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
        margin: 0;
        color: var(--text-dark);
    }

    .app-container {
        width: 100%;
        min-height: 100vh;
        background: white;
        overflow: hidden;
    }

    .app-header {
        background: var(--primary-gradient);
        color: var(--text-light);
        padding: 1.2rem 2rem;
        text-align: center;
        font-weight: 700;
        font-size: 1.8rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .app-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
        animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .control-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: var(--border-glow);
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
        box-shadow: 0 0 15px rgba(79, 172, 254, 0.4);
    }

    .btn-warning {
        background: var(--warning-gradient);
        color: white;
        box-shadow: 0 0 15px rgba(250, 112, 154, 0.4);
    }

    .btn-danger {
        background: var(--danger-gradient);
        color: white;
        box-shadow: 0 0 15px rgba(255, 117, 140, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-dark);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
        transform: translateY(0);
    }

    .status-counts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
    }

    .status-count-box {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .status-count-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .status-count-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .active-box::before { background: var(--success-gradient); }
    .expiring-box::before { background: var(--warning-gradient); }
    .expired-box::before { background: var(--danger-gradient); }
    .all-box::before { background: var(--primary-gradient); }

    .status-count-box h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-count-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .search-container {
        padding: 1.5rem 2rem;
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .search-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: center;
    }

    .search-input {
        padding: 0.8rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        font-size: 0.85rem;
        background: white;
        transition: all 0.2s ease;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .search-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        background: white;
    }

    .search-input::placeholder {
        color: #718096;
        font-size: 0.85rem;
    }

    .table-container {
        padding: 0 2rem 2rem;
        overflow-x: auto;
    }

    #combinedTable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-top: 1rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    #combinedTable thead {
        background: var(--primary-gradient);
    }

    #combinedTable th {
        padding: 1rem 0.8rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.85rem;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        position: relative;
    }

    #combinedTable th::after {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 1px;
        height: 50%;
        background: rgba(255, 255, 255, 0.3);
    }

    #combinedTable th:last-child::after {
        display: none;
    }

    #combinedTable td {
        padding: 0.8rem 0.6rem;
        text-align: center;
        font-weight: 500;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
    }

    #combinedTable tr:last-child td {
        border-bottom: none;
    }

    #combinedTable tr:hover td {
        background: rgba(52, 152, 219, 0.03);
    }

    #combinedTable tr:nth-child(even) {
        background: rgba(245, 245, 245, 0.3);
    }

    #combinedTable td:nth-child(2) {
        color: #2c5282;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 2rem;
        padding: 1rem;
    }

    .pagination-btn {
        padding: 0.6rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: white;
        color: #2c3e50;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 0.85rem;
        min-width: 40px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .pagination-btn:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    .pagination-btn.active {
        background: #2c3e50;
        color: white;
        border-color: #2c3e50;
    }

    /* Modal Styles */
    .column-filter-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .column-filter-modal[aria-hidden="false"] {
        opacity: 1;
        visibility: visible;
    }

    .column-filter-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .column-filter-modal[aria-hidden="false"] .column-filter-content {
        transform: scale(1);
    }

    /* Notification Styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1001;
        transform: translateX(100%);
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        font-size: 0.9rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .notification.show {
        transform: translateX(0);
    }

    /* Confirmation Dialog Styles */
    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .confirm-dialog[aria-hidden="false"] {
        opacity: 1;
        visibility: visible;
    }

    .confirm-dialog-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .confirm-dialog[aria-hidden="false"] .confirm-dialog-content {
        transform: scale(1);
    }

    .confirm-dialog-content h3 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .confirm-dialog-content p {
        color: #666;
        margin-bottom: 1.5rem;
        line-height: 1.5;
    }

    .confirm-dialog-content form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .confirm-dialog-content label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .confirm-dialog-content textarea,
    .confirm-dialog-content input {
        padding: 0.8rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .confirm-dialog-content textarea:focus,
    .confirm-dialog-content input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }

    .confirm-dialog-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }

    .confirm-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .confirm-btn.yes-btn {
        background: var(--danger-gradient);
        color: white;
    }

    .confirm-btn.yes-btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .confirm-btn.yes-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .confirm-btn.no-btn {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .confirm-btn.no-btn:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .search-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .app-header {
            font-size: 1.5rem;
            padding: 1rem;
        }
        
        .header-controls {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }
        
        .control-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .status-counts-container {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        
        .search-grid {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            padding: 0 1rem 1rem;
        }
        
        #combinedTable {
            font-size: 0.8rem;
        }
        
        #combinedTable th,
        #combinedTable td {
            padding: 0.6rem 0.4rem;
        }
    }

    /* Animation for status numbers */
    @keyframes countUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .status-count-number {
        animation: countUp 0.6s ease-out;
    }

    /* Glass morphism effect for containers */
    .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h3>VEHICLE MANAGEMENT FOR FEEDMILL DIVISION</h3>
        </header>

        <div class="header-controls">
            <div class="control-buttons">
                <button id="logoutBtn" class="btn btn-danger" title="Logout" onclick="window.location.href='login.html'">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button id="toggleFormBtn" class="btn btn-secondary" aria-expanded="false" aria-controls="combinedForm">
                    <i class="fas fa-plus-circle"></i> Show Form
                </button>
            </div>
        </div>

        <form
            id="combinedForm"
            style="display:none; max-height:0; overflow:hidden;"
            onsubmit="event.preventDefault(); addRow('combinedTable', ['vehicleNumber', 'policyType', 'policyNumber', 'renewalDate', 'maintenanceType', 'openingKM', 'closingKM', 'kmDriven', 'maintenanceRenewalDate', 'renewalDate2', 'remarks']);"
        >
            <!-- Form inputs would go here -->
        </form>

        <!-- Status count boxes -->
        <div id="statusCounts" class="status-counts-container">
            <div id="activeCountBox" class="status-count-box active-box">
                <h3><i class="fas fa-check-circle"></i> Active</h3>
                <p id="activeCount" class="status-count-number">0</p>
            </div>
            <div id="expiringCountBox" class="status-count-box expiring-box">
                <h3><i class="fas fa-exclamation-triangle"></i> Expiring Soon</h3>
                <p id="expiringCount" class="status-count-number">0</p>
            </div>
            <div id="expiredCountBox" class="status-count-box expired-box">
                <h3><i class="fas fa-times-circle"></i> Expired</h3>
                <p id="expiredCount" class="status-count-number">0</p>
            </div>
            <div id="allCountBox" class="status-count-box all-box">
                <h3><i class="fas fa-list-alt"></i> All</h3>
                <p id="allCount" class="status-count-number">0</p>
            </div>
        </div>

        <div class="search-container">
            <div class="search-grid">
                <input type="text" id="searchMonthInput" class="search-input" placeholder="🔍 Search by Renewal Month..." />
                <input type="text" id="searchStatusInput" class="search-input" placeholder="🔍 Search by Policy Type.." />
                <input type="text" id="searchVehicleNumberInput" class="search-input" placeholder="🔍 Search by Vehicle Number..." />
                <input type="text" id="searchVehicleNumberInput2" class="search-input" placeholder="🔍 Additional Vehicle Filter..." />
                <input type="text" id="searchGpsRenewalDateInput" class="search-input" placeholder="🔍 Search by GPS Renewal Date..." />
            </div>
        </div>

        <div class="table-container">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                <button id="exportPdfBtn" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
                <button id="exportExcelBtn" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button id="reloadBtn" class="btn btn-warning" title="Reload" aria-label="Reload">
                    <i class="fas fa-sync-alt"></i> Reload
                </button>
                <button id="columnFilterBtn" class="btn btn-secondary" title="Select Columns" aria-label="Select Columns">
                    <i class="fas fa-columns"></i> Columns
                </button>
            </div>

            <table id="combinedTable">
                <thead>
                    <tr>
                        <th style="text-align:center;">#</th>
                        <th colspan="17" style="text-align:center;">Vehicle Details</th>
                    </tr>
                    <tr>
                        <th>#</th>
                        <th>Vehicle Number</th>
                        <th>Policy Type</th>
                        <th>Policy Number</th>
                        <th>Renewal Date(Vehicles)</th>
                        <th>Status (I)</th>
                        <th>Service Type</th>
                        <th>Opening KM</th>
                        <th>Closing KM</th>
                        <th>Km Driven</th>
                        <th>Remarks</th>
                        <th>Last Service Date</th>
                        <th style="text-align: center;">Status</th>
                        <th class="gps-column" style="text-align: center;">GPS</th>
                        <th class="shadow-column">Renewal Date(GPS)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Pagination controls -->
            <div id="paginationControls" class="pagination-controls"></div>
        </div>

        <!-- Column selection modal -->
        <div id="columnFilterModal" class="column-filter-modal" role="dialog" aria-modal="true" aria-labelledby="columnFilterTitle" aria-hidden="true" style="display:none;">
            <div class="column-filter-content">
                <h3 id="columnFilterTitle">Select Columns to Display</h3>
                <form id="columnFilterForm">
                    <!-- Checkboxes will be dynamically populated here -->
                </form>
                <div class="column-filter-buttons">
                    <button id="saveColumnFilterBtn" type="button">Save</button>
                    <button id="cancelColumnFilterBtn" type="button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Notification container -->
        <div id="notification" class="notification" role="alert" aria-live="assertive" aria-atomic="true" style="display:none;"></div>

        <!-- Confirmation dialog container -->
        <div id="confirmDialog" class="confirm-dialog" role="alertdialog" aria-modal="true" aria-labelledby="confirmDialogTitle" aria-describedby="confirmDialogDesc" style="display:none;">
            <div class="confirm-dialog-content">
                <h3 id="confirmDialogTitle">Confirm Deletion</h3>
                <p id="confirmDialogDesc">Please provide the reason for deletion and admin name to proceed.</p>
                <form id="deleteForm">
                    <label for="deleteReason">Reason for Delete:</label>
                    <textarea id="deleteReason" name="deleteReason" rows="3" required placeholder="Enter reason for deletion"></textarea>
                    <label for="adminName">Admin Name:</label>
                    <input type="text" id="adminName" name="adminName" required placeholder="Enter admin name" />
                    <div class="confirm-dialog-buttons">
                        <button type="submit" id="confirmYesBtn" class="confirm-btn yes-btn" disabled>Delete</button>
                        <button type="button" id="confirmNoBtn" class="confirm-btn no-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
     // * Export table data to PDF using jsPDF and autoTable with plugin availability check
    function exportTableToPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');

            if (typeof doc.autoTable !== 'function') {
                alert('jsPDF autoTable plugin is not loaded. Please include it before exporting to PDF.');
                return;
            }

            const table = document.getElementById('combinedTable');
            // Get visible header cells from the second row of thead
            const headerCells = table.querySelectorAll('thead tr:nth-child(2) th');
            const visibleColumns = [];
            let headers = [];
            // Get visible headers from table
            for (let i = 0; i < headerCells.length; i++) {
                if (headerCells[i].style.display !== 'none') {
                    visibleColumns.push(i);
                    headers.push(headerCells[i].textContent.trim());
                }
            }
            // Always add Vehicle Type, Make-Model, Division to PDF export after Vehicle Number
            const insertAfter = (arr, afterKey, newKey) => {
                const idx = arr.indexOf(afterKey);
                if (idx !== -1 && !arr.includes(newKey)) arr.splice(idx + 1, 0, newKey);
            };
            insertAfter(headers, 'Vehicle Number', 'Vehicle Type');
            insertAfter(headers, 'Vehicle Type', 'Make-Model');
            // Do NOT add Division yet

            // Collect all row data first
            const rows = table.querySelectorAll('tbody tr');
            let allRows = [];
            let divisionExists = false;
            rows.forEach((row, index) => {
                if (row.style.display === 'none') return;
                const cells = row.cells;
                const rowData = {};
                // Parse Vehicle Number for Division, Make-Model, Vehicle Type
                let vehicleNumberFull = cells[1] ? cells[1].textContent.trim() : '';
                let vehicleNumber = '';
                let makeModelArr = [];
                let division = '';
                let vehicleType = '';
                const parts = vehicleNumberFull.split('[');
                vehicleNumber = parts[0].trim();
                for (let i = 1; i < parts.length; i++) {
                    const part = parts[i].replace(']', '').trim();
                    if (["PRO", "R.O", "H.O"].includes(part.toUpperCase())) {
                        division = `[${part}]`;
                        divisionExists = true;
                    } else if (["4 wheel", "heavy", "2 wheel"].includes(part.toLowerCase())) {
                        vehicleType = `[${part.toUpperCase()}]`;
                    } else {
                        makeModelArr.push(`[${part}]`);
                    }
                }
                headers.forEach((header, hIdx) => {
                    switch(header) {
                        case '#': rowData[header] = (index + 1).toString(); break;
                        case 'Vehicle Number': 
                            // Apply the same styling as in the HTML table
                            rowData[header] = vehicleNumber; 
                            break;
                        case 'Vehicle Type': rowData[header] = vehicleType; break;
                        case 'Division': rowData[header] = division; break;
                        case 'Make-Model': rowData[header] = makeModelArr.join(' '); break;
                        default:
                            let colIdx = Array.from(headerCells).findIndex(th => th.textContent.trim() === header);
                            rowData[header] = cells[colIdx] ? cells[colIdx].textContent.trim() : '';
                    }
                });
                // Add helper fields for grouping/sorting
                rowData._vehicleType = vehicleType;
                rowData._division = division;
                // Parse year and month from Renewal Date(Vehicle)
                let renewalDate = rowData['Renewal Date(Vehicles)'] || rowData['Renewal Date (Vehicles)'] || '';
                let year = 0, month = '';
                if (renewalDate) {
                    const parts = renewalDate.split('-');
                    if (parts.length === 3) {
                        month = parts[1];
                        year = parseInt(parts[2], 10);
                    }
                }
                rowData._renewalYear = year;
                rowData._renewalMonth = month;
                allRows.push(rowData);
            });

            // Only add Division column if at least one division exists
            if (divisionExists) {
                insertAfter(headers, 'Make-Model', 'Division');
            } else {
                headers = headers.filter(h => h !== 'Division');
                allRows.forEach(row => { delete row['Division']; });
            }

            // Group and sort data, filter out duplicates
            const typeOrder = ['[2 WHEEL]', '[4 WHEEL]', '[HEAVY]'];
            const divisionOrder = ['[PRO]', '[R.O]', '[H.O]'];
            const monthOrder = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            let data = [];
            let uniqueSet = new Set();
            typeOrder.forEach(type => {
                let typeRows = allRows.filter(r => r._vehicleType === type);
                divisionOrder.forEach(division => {
                    let divisionRows = typeRows.filter(r => r._division === division);
                    // Sort by year, then month, then day
                    divisionRows.sort((a, b) => {
                        if (a._renewalYear !== b._renewalYear) return a._renewalYear - b._renewalYear;
                        let aIdx = monthOrder.indexOf(a._renewalMonth);
                        let bIdx = monthOrder.indexOf(b._renewalMonth);
                        if (aIdx !== bIdx) return aIdx - bIdx;
                        // Parse day
                        let aDate = a['Renewal Date(Vehicles)'] || a['Renewal Date (Vehicles)'] || '';
                        let bDate = b['Renewal Date(Vehicles)'] || b['Renewal Date (Vehicles)'] || '';
                        let aParts = aDate.split('-');
                        let bParts = bDate.split('-');
                        let aDay = aParts.length === 3 ? parseInt(aParts[0], 10) : 0;
                        let bDay = bParts.length === 3 ? parseInt(bParts[0], 10) : 0;
                        return aDay - bDay;
                    });
                    divisionRows.forEach(r => {
                        // Create a unique key for each row
                        let uniqueKey = `${r['Vehicle Number']}_${r['Renewal Date(Vehicles)'] || r['Renewal Date (Vehicles)']}_${r['Division']}_${r['Make-Model']}`;
                        if (!uniqueSet.has(uniqueKey)) {
                            uniqueSet.add(uniqueKey);
                            delete r._vehicleType;
                            delete r._division;
                            delete r._renewalYear;
                            delete r._renewalMonth;
                            data.push(r);
                        }
                    });
                });
                // Other divisions
                let otherDivisionRows = typeRows.filter(r => !divisionOrder.includes(r._division));
                otherDivisionRows.sort((a, b) => {
                    if (a._renewalYear !== b._renewalYear) return a._renewalYear - b._renewalYear;
                    let aIdx = monthOrder.indexOf(a._renewalMonth);
                    let bIdx = monthOrder.indexOf(b._renewalMonth);
                    if (aIdx !== bIdx) return aIdx - bIdx;
                    let aDate = a['Renewal Date(Vehicles)'] || a['Renewal Date (Vehicles)'] || '';
                    let bDate = b['Renewal Date(Vehicles)'] || b['Renewal Date (Vehicles)'] || '';
                    let aParts = aDate.split('-');
                    let bParts = bDate.split('-');
                    let aDay = aParts.length === 3 ? parseInt(aParts[0], 10) : 0;
                    let bDay = bParts.length === 3 ? parseInt(bParts[0], 10) : 0;
                    return aDay - bDay;
                });
                otherDivisionRows.forEach(r => {
                    let uniqueKey = `${r['Vehicle Number']}_${r['Renewal Date(Vehicles)'] || r['Renewal Date (Vehicles)']}_${r['Division']}_${r['Make-Model']}`;
                    if (!uniqueSet.has(uniqueKey)) {
                        uniqueSet.add(uniqueKey);
                        delete r._vehicleType;
                        delete r._division;
                        delete r._renewalYear;
                        delete r._renewalMonth;
                        data.push(r);
                    }
                });
            });

            // Helper function to format date as dd-mm-yyyy
            function formatDateDDMMYYYY(date) {
                const d = date.getDate().toString().padStart(2, '0');
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const y = date.getFullYear();
                return `${d}-${m}-${y}`;
            }

            // Add heading text above the table with professional styling
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text('BHARATH AGROVET INDUSTRIES-[FEEDMILL]-VEHICLE POLICY REPORT', doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });

            // Add current date below heading
            const currentDateStr = formatDateDDMMYYYY(new Date());
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.text(`Date: ${currentDateStr}`, doc.internal.pageSize.getWidth() / 2, 45, { align: 'center' });

            // Generate PDF with autoTable, startY adjusted to leave space for heading and date
            // Ensure '#' column is serial after filtering and sorting
            data.forEach((row, idx) => {
                if (row['#'] !== undefined) {
                    row['#'] = (idx + 1).toString();
                }
            });
            doc.autoTable({
                columns: headers.map(header => ({ header: header, dataKey: header })),
                body: data,
                startY: 60,
                styles: {
                    cellPadding: 4,
                    lineWidth: 0.5,
                    lineColor: [0, 0, 0],
                    fontSize: 10,
                },
                columnStyles: headers.reduce((acc, header, index) => {
                    if (header === 'Vehicle Number') {
                        acc[header] = { cellWidth: 'auto', halign: 'center', fillColor: index % 2 === 0 ? [240, 240, 240] : null, fontStyle: 'bold', textColor: [0, 0, 128] };
                    } else {
                        acc[header] = { cellWidth: 'auto', halign: 'center', fillColor: index % 2 === 0 ? [240, 240, 240] : null, fontStyle: 'bold', textColor: [0, 0, 0] };
                    }
                    return acc;
                }, {}),
                didParseCell: function(data) {
                    // Apply status colors to Status and Days Left columns
                    if (data.cell.raw) {
                        const cellValue = data.cell.raw.toString().toUpperCase();
                        
                        if (data.column.dataKey === 'Status' || data.column.dataKey === 'Status (I)') {
                            if (cellValue.includes('ACTIVE')) {
                                data.cell.styles.textColor = [0, 128, 0]; // Green
                            } else if (cellValue.includes('EXPIRING SOON')) {
                                data.cell.styles.textColor = [255, 165, 0]; // Orange/Yellow
                            } else if (cellValue.includes('EXPIRED')) {
                                data.cell.styles.textColor = [255, 0, 0]; // Red
                            }
                        }
                        
                        if (data.column.dataKey === 'DAYS LEFT' || data.column.dataKey.includes('DAYS')) {
                            const days = parseInt(cellValue);
                            if (!isNaN(days)) {
                                if (days > 30) {
                                    data.cell.styles.textColor = [0, 128, 0]; // Green
                                } else if (days > 7) {
                                    data.cell.styles.textColor = [255, 165, 0]; // Orange/Yellow
                                } else {
                                    data.cell.styles.textColor = [255, 0, 0]; // Red
                                }
                            }
                        }
                    }
                },
                headStyles: headers.reduce((acc, header) => {
                    acc[header] = { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', halign: 'center', font: 'helvetica', fontSize: 10 };
                    return acc;
                }, {}),
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                didDrawPage: function (data) {
                    // Add a horizontal line above footer
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.line(40, pageHeight - 30, pageWidth - 40, pageHeight - 30);

                    // Add footer text at the bottom center with italic style
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('all rights reserved by Deeksh@y', pageWidth / 2, pageHeight - 15, { align: 'center' });

                    // Add page number at bottom right corner in small font
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${data.pageNumber}`, pageWidth - 60, pageHeight - 15);
                }
            });

        doc.save('feedmill_vehicle-report.pdf');
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please check console for details.');
    }
}
       // Set division in sessionStorage for this tab
        sessionStorage.setItem('division', 'feedmill');
        
        // Function to style only the vehicle number part (without brackets)
        function styleVehicleNumbers() {
            const vehicleCells = document.querySelectorAll('#combinedTable td:nth-child(2)');
            
            vehicleCells.forEach(cell => {
                const fullText = cell.textContent.trim();
                const parts = fullText.split('[');
                const vehicleNumber = parts[0].trim(); // Get the actual vehicle number part
                
                if (vehicleNumber && parts.length > 1) {
                    // Create HTML with the vehicle number styled and brackets in normal text
                    const bracketContent = fullText.substring(vehicleNumber.length);
                    cell.innerHTML = `<span style="color: #87CEEB; font-weight: bold;">${vehicleNumber}</span>${bracketContent}`;
                }
            });
        }
        
        // Run the styling function when the page loads
        document.addEventListener('DOMContentLoaded', styleVehicleNumbers);
        
        // Also run it after any table updates (you might need to call this from other scripts)
        window.styleVehicleNumbers = styleVehicleNumbers;
    </script>
    <script src="scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="export.js"></script>
</body>
</html>

    
    
